<!-- Poker Term Modal (for glossary popups) -->
<div class="poker-term-modal-backdrop" id="pokerTermBackdrop" onclick="closePokerTermModal()"></div>
<div class="poker-term-modal" id="pokerTermModal" role="dialog" aria-modal="true" aria-labelledby="pokerTermTitle">
  <div class="poker-term-modal__header">
    <button class="poker-term-modal__close" onclick="closePokerTermModal()" aria-label="Close">&times;</button>
    <h3 class="poker-term-modal__term" id="pokerTermTitle"></h3>
  </div>
  <div class="poker-term-modal__body">
    <div class="poker-term-modal__definition" id="pokerTermDefinition"></div>
  </div>
</div>

<script>
(function() {
  let currentTermElement = null;
  let glossaryData = null;
  let fetchPromise = null;

  function loadGlossary() {
    if (glossaryData) return Promise.resolve(glossaryData);
    if (!fetchPromise) {
      fetchPromise = fetch('/data/glossary.json')
        .then(function(res) { return res.json(); })
        .then(function(data) { glossaryData = data; return data; })
        .catch(function(e) {
          console.warn('Failed to load glossary data:', e);
          fetchPromise = null;
        });
    }
    return fetchPromise;
  }

  window.openPokerTermModal = function(element) {
    var slug = element.dataset.term;

    loadGlossary().then(function(data) {
      if (!data) return;
      var entry = data[slug];

      if (!entry) {
        console.warn('Glossary entry not found:', slug);
        return;
      }

      document.getElementById('pokerTermTitle').textContent = entry.term;
      document.getElementById('pokerTermDefinition').innerHTML = entry.content;

      document.getElementById('pokerTermBackdrop').classList.add('active');
      document.getElementById('pokerTermModal').classList.add('active');

      currentTermElement = element;

      // Trap focus in modal
      document.getElementById('pokerTermModal').querySelector('.poker-term-modal__close').focus();

      // Prevent body scroll on mobile
      document.body.style.overflow = 'hidden';
    });
  };

  window.closePokerTermModal = function() {
    document.getElementById('pokerTermBackdrop').classList.remove('active');
    document.getElementById('pokerTermModal').classList.remove('active');

    // Restore body scroll
    document.body.style.overflow = '';

    // Highlight the term briefly and return focus
    if (currentTermElement) {
      currentTermElement.classList.add('poker-term--just-viewed');
      currentTermElement.focus();
      var el = currentTermElement;
      setTimeout(() => {
        el.classList.remove('poker-term--just-viewed');
      }, 600);
      currentTermElement = null;
    }
  };

  // Close on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('pokerTermModal').classList.contains('active')) {
      closePokerTermModal();
    }
  });
})();
</script>
